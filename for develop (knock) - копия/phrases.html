<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <title>English phrases</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <link href="css/style.css" rel="stylesheet">
    <link href="css/sidenav.css" rel="stylesheet">
</head>

<body>


    <div class="sidenav">
        <span data-bind="text: 'Unique words: ['+wordsInSentences().length+']'"></span>
        <div data-bind="foreach: wordsInSentences">
            <span>
                <label class="word-link" data-bind="text: $data.word"></label>
                <!-- <input type="checkbox" data-bind="checked: false" /> -->
            </span>
        </div>
    </div>

    <div class="main">
        <section id="content">
            <br><br>
            <h2 class="center">Training English phrases with native speakers</h2>

            <form class="center" data-bind="submit: loadRecordByWord">
                <label>Request string: </label>
                <input id="wordInput" data-bind="value: searchString" type="text" list="wordList">
                <datalist id="wordList" data-bind="foreach: availableWords">
                    <option data-bind="value: $data"></option>
                </datalist>
                <input data-bind="click: clearButtonClick" type="button" value=" X ">
                <input data-bind="click: addWordToSet" type="button" value="Add to set">
                <input type="submit" value="Load word">

                <br>
                <label><input name="searchType" type="radio" value="0"
                        data-bind="checked: radioSelectedOptionValue" />use
                    search with database references</label>
                <label><input name="searchType" type="radio" value="1"
                        data-bind="checked: radioSelectedOptionValue" />use
                    full search by sentences</label>
                <br>
                <label data-bind="visible: radioSelectedOptionValue() == 1"><input type="checkbox"
                        data-bind="checked: isUseCaseSensitiveSearch, visible: radioSelectedOptionValue() == 1" />case
                    sensitive</label>
                <label><input type="checkbox" data-bind="checked: isShuffle" />shuffle</label>

                <p><textarea data-bind="textInput: setWords" rows="15" cols="25" name="text"></textarea></p>
                <input data-bind="click: clearSetClick" type="button" value=" X ">
                <input data-bind="click: loadSet" type="button" value="Load set">

                <br><br>
                <span>Available examples in table: </span>
                <span data-bind="text: (records().length)"></span>
            </form><br><br>


            <table class="table-sentences">
                <tbody data-bind="foreach: records">
                    <tr>
                        <td class="center">
                            <span data-bind="text: ($index()+1)"></span><br>
                            <input data-bind="event: {change: $parent.showQuestionCheckboxChange}" class="show_question"
                                type="checkbox">
                            <span data-bind="text: $data.id()"></span>
                        </td>
                        <td>
                            <span data-bind="attr: {tabindex: ($index() + 100001), data_title: $data.rule()}"
                                class='support question_hidden' data-title=''>
                                <em>?</em>
                            </span>
                            <span data-bind="text: $parent.getRusianWithFirstUpperLetter($data.russian())"
                                class="question question_hidden"></span>
                            <input data-bind="event: {keyup: $parent.inputFiledKeyUp}, attr: {tabindex: ($index() + 1)}"
                                class='input-field' type="text" placeholder="Введите перевод">
                            <span
                                data-bind="html: $parent.getEnglishWihtNamesHintsAndFirstUpper($data.english())"></span><br>
                            <div class='check'></div>
                            <button data-bind="click: $parent.showEditor">Show editor</button>
                            <button data-bind="click: $parent.hideEditor, visible: ($data.mode() === 'edit')">Hide
                                editor</button>

                            <div data-bind="visible: ($data.mode() === 'edit')">
                                <label>Id</label>
                                <input data-bind="value: $parent.newId" type="text" class='input-field'><br>
                                <label>Word</label>
                                <input data-bind="value: $parent.newWord" type="text" class='input-field'><br>
                                <label>Russian</label>
                                <input data-bind="value: $parent.newRussian" type="text" class='input-field'><br>
                                <label>English</label>
                                <input data-bind="value: $parent.newEnglish" type="text" class='input-field'><br>
                                <label>Sound</label>
                                <input data-bind="value: $parent.newSoundPath" type="text" class='input-field'><br>
                                <label>Rule</label>
                                <input data-bind="value: $parent.newRule" type="text" class='input-field'><br>
                                <button data-bind="click: $parent.updateRecord">Update record</button>
                            </div>

                        </td>
                        <td class="center">
                            <a data-bind="event: {click: $parent.musicButtonClick}" class="music-button"><img
                                    src="img/player_play.png"></a>
                            <audio data-bind="attr: {src: '../words/'+ $data.word() + '/' + $data.soundPath()}"
                                class="player" type="audio/mpeg"></audio>
                            <br><input
                                data-bind="event: {change: $parent.inputRangeInputAndChange, input: $parent.inputRangeInputAndChange}"
                                type="range" step="0.1" min="0.2" max="2" value="1" class="speed" />
                            <br><span class="speed-text">1.0</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </div>


    <script type='text/javascript' src='js/knockout-3.5.0.js'></script>
    <script src="js/utils.js"></script>

    <script>

        var PhrasesViewModel = function () {
            var self = this;

            self.records = ko.observableArray([]);
            self.availableWords = ko.observableArray();
            self.setWords = ko.observable("");
            self.searchString = ko.observable("");
            self.records = ko.observableArray();
            self.wordsInSentences = ko.observableArray([]);

            self.isShuffle = false;
            self.isUseCaseSensitiveSearch = false;

            // for edit mode
            self.newId = ko.observable("");
            self.newWord = ko.observable("");
            self.newRussian = ko.observable("");
            self.newEnglish = ko.observable("");
            self.newRule = ko.observable("");
            self.newSoundPath = ko.observable("");
            self.radioSelectedOptionValue = ko.observable("0")

            self.loadSet = function () {
                self.setWords(self.setWords().replace(/ \[.*\]/g, ""));
                let words = self.setWords().split('\n');
                self.records([]);
                words.forEach(element => {

                    if (element === "") {
                        return;
                    }

                    //use search with database references (radioSelectedOptionValue=0)
                    let url = "http://localhost:8080/records/" + element.toLowerCase();

                    // use full search by sentences (radioSelectedOptionValue=1)
                    if (self.radioSelectedOptionValue() === "1") {
                        url = "http://localhost:8080/records/query/" + element;
                        if (self.isUseCaseSensitiveSearch) {
                            url = url + "/0";
                        } else {
                            url = url + "/1";
                        }
                    }

                    $.ajax(url, {
                        type: "GET",
                        success: function (allData) {
                            var json = ko.toJSON(allData);
                            var recordsFromServer = JSON.parse(json);
                            var array = [];
                            self.setWords(self.setWords().replace(new RegExp("^" + element + "$", "gm"), element + " [" + recordsFromServer.length + "]"))
                            if (recordsFromServer.length === 0) {
                                console.log("Empty set for " + element);
                                return;
                            } else {
                                console.log("Process: [" + element + "] - " + recordsFromServer.length)
                            }
                            recordsFromServer.forEach(element => {
                                var rec = new Phrase({
                                    id: element.id,
                                    word: element.word,
                                    russian: element.russian,
                                    english: element.english,
                                    rule: element.rule,
                                    soundPath: element.soundPath,
                                    mode: "",
                                    currentAnswer: ""
                                });
                                array.push(rec);
                            });
                            Array.prototype.push.apply(array, self.records());
                            if (self.isShuffle) {
                                array = shuffle(array);
                            }
                            self.records(array);

                            //fill in words array
                            let wordsMap = new Map();
                            self.records().forEach(r => {
                                console.log(r);
                                r.english().replace(/\[|\]/g, "").split(/[ ,:;?.!]/g).forEach(str => {
                                    if (str != "") {
                                        if (wordsMap.get(str)) {
                                            wordsMap.set(str, wordsMap.get(str) + 1);
                                        } else {
                                            wordsMap.set(str, 1);
                                        }
                                    }
                                });
                                //console.log(wordsMap);
                                self.wordsInSentences();
                            });
                            let wordsArray = [];
                            wordsMap.forEach((value, key, map) => {
                                wordsArray.push({
                                    word: key,
                                    count: value
                                });
                            });
                            wordsArray.sort((ob1, ob2) => (ob1.word.toLowerCase() > ob2.word.toLowerCase()) ? 1 : ((ob1.word.toLowerCase() < ob2.word.toLowerCase()) ? -1 : 0));
                            console.log(wordsArray);
                            self.wordsInSentences(wordsArray);
                        }
                    });
                });
            }

            self.addWordToSet = function () {
                var currentSet = self.setWords();
                if (self.searchString() != "") {
                    if (currentSet != "") {
                        currentSet = currentSet + '\n';
                    }
                    currentSet = currentSet + self.searchString();
                    self.setWords(currentSet);
                }
            }

            self.clearButtonClick = function () {
                self.searchString("");
            }

            self.clearSetClick = function () {
                self.setWords("");
            }

            self.loadAllAvailableWord = function () {
                $.ajax("http://localhost:8080/records/words", {
                    type: "GET",
                    success: function (allData) {
                        var json = ko.toJSON(allData);
                        var wordsFromServer = JSON.parse(json);
                        var array = [];
                        wordsFromServer.forEach(element => {
                            array.push(element.value);
                        });
                        self.availableWords(array);
                    }
                });
            }

            // load records from server: GET on records resource
            self.loadRecordByWord = function () {
                //use search with database references (radioSelectedOptionValue=0)
                let url = "http://localhost:8080/records/" + self.searchString().toLowerCase();

                // use full search by sentences (radioSelectedOptionValue=1)
                if (self.radioSelectedOptionValue() === "1") {
                    url = "http://localhost:8080/records/query/" + self.searchString();
                    if (self.isUseCaseSensitiveSearch) {
                        url = url + "/0";
                    } else {
                        url = url + "/1";
                    }
                }

                $.ajax(url, {
                    type: "GET",
                    success: function (allData) {
                        var json = ko.toJSON(allData);
                        var recordsFromServer = JSON.parse(json);
                        var array = [];
                        recordsFromServer.forEach(element => {
                            var rec = new Phrase({
                                id: element.id,
                                word: element.word,
                                russian: element.russian,
                                english: element.english,
                                rule: element.rule,
                                soundPath: element.soundPath,
                                mode: "",
                                currentAnswer: ""
                            });
                            array.push(rec);
                        });

                        if (self.isShuffle) {
                            array = shuffle(array);
                        }
                        console.log(array);
                        self.records(array);
                    }
                });
            };

            self.showEditor = function (record) {

                self.records().forEach(element => {
                    if (element.mode() === "edit") {
                        element.mode("");
                    }
                });

                record.mode("edit");
                self.newId(record.id());
                self.newEnglish(record.english());
                self.newRussian(record.russian());
                self.newWord(record.word());
                self.newRule(record.rule());
                self.newSoundPath(record.soundPath());
            }

            self.hideEditor = function (record) {
                record.mode("");
            }

            self.updateRecord = function (record) {
                var dataJson = '{"id":' + self.newId() + ',"word":"' + self.newWord() + '","russian":"' + self.newRussian() + '","english":"' + self.newEnglish() + '","soundPath":"' + self.newSoundPath() + '","rule":"' + self.newRule() + '"}';
                console.log(dataJson);
                $.ajax("http://localhost:8080/records/" + self.newId(), {
                    data: dataJson,
                    type: "put",
                    contentType: "application/json",
                    success: function (allData) {
                        alert("Record was successful updated");
                        record.mode("");
                        record.id(self.newId());
                        record.word(self.newWord());
                        record.russian(self.newRussian());
                        record.english(self.newEnglish());
                        record.soundPath(self.newSoundPath());
                        record.rule(self.newRule());
                    }
                });
            }

            self.inputFiledKeyUp = function (record, event) {
                var $this = $(event.target);

                if ($this.hasClass('invalid')) {
                    $this.removeClass('invalid')
                }

                if ($this.hasClass('correct')) {
                    $this.removeClass('correct')
                }

                if (event.keyCode == 113) {
                    let checkbox = $this.closest('tr')[0].getElementsByClassName('show_question')[0];
                    $(checkbox).trigger('click');
                }

                if (event.keyCode == 13) {
                    var actualVal = "";
                    tipColl = $this.closest('td')[0].getElementsByClassName('tip');
                    for (let i = 0; i < tipColl.length; i++) {
                        actualVal = actualVal + tipColl[i].innerHTML;
                    }
                    actualVal = actualVal.replace(/[\[\]]/g, "");
                    var currentVal = $this.val();
                    var checkDiv = $this.closest('td')[0].getElementsByClassName('check')[0];
                    currentVal = currentVal.replace(/[,:;?.!]/g, "").replace(/[ ]{2,}/g, " ");
                    actualVal = actualVal.replace(/[,:;?.!]/g, "").replace(/[ ]{2,}/g, " ");
                    $this.closest('tr')[0].getElementsByClassName('music-button')[0].click();
                    if (currentVal != actualVal) {
                        $this.addClass('invalid');
                        checkDiv.innerHTML = checkTranslate(actualVal, currentVal);
                    } else {
                        $this.addClass('correct');
                        checkDiv.innerHTML = '';
                    }
                }

                if (event.keyCode == 40) {
                    let currentVal = Number($this.closest('tr')[0].getElementsByClassName('speed')[0].value) - 0.1;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].value = currentVal;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].dispatchEvent(new Event("change"));
                }

                if (event.keyCode == 38) {
                    let currentVal = Number($this.closest('tr')[0].getElementsByClassName('speed')[0].value) + 0.1;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].value = currentVal;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].dispatchEvent(new Event("change"));
                }
            };

            self.musicButtonClick = function (record, event) {
                var $this = $(event.target);
                audioEl = $this.closest('td')[0].getElementsByTagName('audio')[0];
                audioEl.playbackRate = $this.closest('td')[0].getElementsByClassName('speed')[0].value;
                audioEl.play();
            }

            self.inputRangeInputAndChange = function (record, event) {
                var $this = $(event.target);
                $this.nextAll('.speed-text')[0].innerHTML = parseFloat($this.val()).toFixed(1);
            }

            self.showQuestionCheckboxChange = function (record, event) {
                var $this = $(event.target);
                if ($this.is(":checked")) {
                    $this.closest('tr')[0].getElementsByClassName('question')[0].classList.remove('question_hidden');
                    if ($this.closest('tr')[0].getElementsByClassName('support').length > 0) {
                        $this.closest('tr')[0].getElementsByClassName('support')[0].classList.remove('question_hidden');
                    }
                    return;
                }
                $this.closest('tr')[0].getElementsByClassName('question')[0].classList.add('question_hidden');
                if ($this.closest('tr')[0].getElementsByClassName('support').length > 0) {
                    $this.closest('tr')[0].getElementsByClassName('support')[0].classList.add('question_hidden');
                }
            }

            self.getEnglishWihtNamesHintsAndFirstUpper = function (english) {
                var result = getWithFirstUpperCase(english);
                return "<span class='tip hide'>" + result.replace(/(\[.*?\])/g, "</span><span class='tip show'>$1</span><span class='tip hide'>") + "</span>";
            };

            self.getRusianWithFirstUpperLetter = function (russian) {
                return getWithFirstUpperCase(russian)
            };

            // init events
            self.loadAllAvailableWord();
        };

        var Phrase = function (data) {
            var self = this;
            self.id = ko.observable(data.id);
            self.word = ko.observable(data.word);
            self.russian = ko.observable(data.russian);
            self.english = ko.observable(data.english);
            self.rule = ko.observable(data.rule);
            self.soundPath = ko.observable(data.soundPath);
            self.mode = ko.observable(data.mode);
            self.currentAnswer = ko.observable(data.currentAnswer);
        };

        // var DataSupplier = function () {

        //     var self = this;

        //     self.phrases = [];

        //     self.getPhrasesByWord = function (word) {
        //         console.log("Inside getPhrasesByWord")
        //         self.records = [];
        //         $.ajax("http://localhost:8080/records/" + word, {
        //             type: "GET",
        //             success: function (allData) {
        //                 var json = ko.toJSON(allData);
        //                 var recordsFromServer = JSON.parse(json);
        //                 recordsFromServer.forEach(element => {
        //                     var rec = new Phrase({
        //                         id: element.id,
        //                         word: element.word,
        //                         russian: element.russian,
        //                         english: element.english,
        //                         rule: element.rule,
        //                         soundPath: element.soundPath,
        //                         mode: "",
        //                         currentAnswer: ""
        //                     });
        //                     self.phrases.push(rec);
        //                 });
        //             }
        //         });
        //         console.log(self.phrases);
        //     }
        // }

        ko.options.useOnlyNativeEvents = true;
        ko.applyBindings(new PhrasesViewModel());
    </script>
</body>

</html>